<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarkDoc - Markdown to Document Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 0;
        }

        .sidebar {
            width: 320px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #1a252f;
        }

        .sidebar h2 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 12px;
            opacity: 0.7;
            letter-spacing: 0.5px;
        }

        .sidebar h3 {
            font-size: 13px;
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .mode-toggle {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #34495e;
            background: #34495e;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 200ms;
        }

        .mode-btn.active {
            background: #3498db;
            border-color: #2980b9;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }

        .mode-btn:hover:not(.active) {
            background: #41536d;
        }

        .pdf-settings {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .setting-group {
            background: #34495e;
            padding: 10px;
            border-radius: 4px;
        }

        .setting-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            opacity: 0.8;
        }

        .setting-group select,
        .setting-group input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #7f8c8d;
            border-radius: 3px;
            background: #2c3e50;
            color: white;
            font-size: 12px;
        }

        .setting-group input[type="checkbox"] {
            width: auto;
            margin-right: 6px;
        }

        .setting-group input[type="text"],
        .setting-group input[type="number"] {
            width: 100%;
            padding: 6px 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group label {
            margin: 0;
            text-transform: none;
            font-weight: 400;
            opacity: 1;
        }

        .header-footer-options {
            display: none;
            gap: 10px;
            margin-top: 8px;
        }

        .header-footer-options.visible {
            display: flex;
            flex-direction: column;
        }

        .position-group {
            display: flex;
            gap: 4px;
        }

        .position-btn {
            flex: 1;
            padding: 4px;
            border: 1px solid #7f8c8d;
            background: #2c3e50;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 150ms;
        }

        .position-btn.selected {
            background: #3498db;
            border-color: #2980b9;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 200ms;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #229954;
            box-shadow: 0 0 8px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary:hover {
            background: #c0392b;
        }

        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .editor-header {
            padding: 12px 16px;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            font-size: 12px;
            font-weight: 600;
            color: #34495e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #markdown-input {
            flex: 1;
            padding: 16px;
            border: none;
            outline: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            background: white;
            color: #2c3e50;
        }

        #markdown-input::placeholder {
            color: #bdc3c7;
        }

        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .preview-header {
            padding: 12px 16px;
            background: #ecf0f1;
            border-bottom: 1px solid #bdc3c7;
            border-left: 1px solid #bdc3c7;
            font-size: 12px;
            font-weight: 600;
            color: #34495e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: white;
        }

        .slide {
            background: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 400px;
            page-break-inside: avoid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slide:last-child {
            margin-bottom: 0;
        }

        #document-preview {
            background: white;
            padding: 30px;
        }

        .preview-content h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            margin-top: 24px;
            color: #2c3e50;
        }

        .preview-content h1:first-child {
            margin-top: 0;
        }

        .preview-content h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 20px;
            color: #34495e;
        }

        .preview-content h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            margin-top: 16px;
            color: #34495e;
        }

        .preview-content h4,
        .preview-content h5,
        .preview-content h6 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 12px;
        }

        .preview-content p {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #555;
        }

        .preview-content ul,
        .preview-content ol {
            margin-left: 24px;
            margin-bottom: 12px;
        }

        .preview-content li {
            margin-bottom: 6px;
            line-height: 1.5;
            color: #555;
        }

        .preview-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            color: #d63384;
        }

        .preview-content pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .preview-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .preview-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 12px;
            margin-left: 0;
            margin-bottom: 12px;
            color: #7f8c8d;
            font-style: italic;
        }

        .preview-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 12px;
            border: 1px solid #bdc3c7;
        }

        .preview-content table th,
        .preview-content table td {
            border: 1px solid #bdc3c7;
            padding: 8px 12px;
            text-align: left;
        }

        .preview-content table th {
            background: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
        }

        .preview-content a {
            color: #3498db;
            text-decoration: none;
        }

        .preview-content a:hover {
            text-decoration: underline;
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .editor-section,
            .preview-section {
                flex: 1;
            }
        }

        @media print {
            body {
                background: white !important;
            }
            .container {
                display: block;
            }
            .sidebar {
                display: none;
            }
            .main-content {
                display: block;
            }
            .editor-section {
                display: none;
            }
            .preview-section {
                display: block;
                position: static;
            }
            .preview-container {
                overflow: visible;
                padding: 0;
            }
            .slide {
                page-break-before: always;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>MarkDoc</h2>
            <p style="font-size: 12px; opacity: 0.6; margin-bottom: 16px;">Markdown to Document Converter</p>

            <h3>Mode</h3>
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="document">Document</button>
                <button class="mode-btn" data-mode="slides">Slides</button>
            </div>

            <h3>PDF Settings</h3>
            <div class="pdf-settings">
                <div class="setting-group">
                    <label>Paper Size</label>
                    <select id="pdf-paper">
                        <option value="a4">A4 (210×297mm)</option>
                        <option value="letter">Letter (8.5×11in)</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label>Orientation</label>
                    <select id="pdf-orientation">
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label>Margins (mm)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                        <div>
                            <input type="number" id="margin-top" placeholder="Top" value="20" min="0">
                        </div>
                        <div>
                            <input type="number" id="margin-right" placeholder="Right" value="20" min="0">
                        </div>
                        <div>
                            <input type="number" id="margin-bottom" placeholder="Bottom" value="20" min="0">
                        </div>
                        <div>
                            <input type="number" id="margin-left" placeholder="Left" value="20" min="0">
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-header" />
                        <label for="enable-header">Header</label>
                    </div>
                    <div class="header-footer-options" id="header-options">
                        <input type="text" id="header-text" placeholder="Header text" />
                        <div class="position-group">
                            <button class="position-btn selected" data-position="left">Left</button>
                            <button class="position-btn" data-position="center">Center</button>
                            <button class="position-btn" data-position="right">Right</button>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-footer" />
                        <label for="enable-footer">Footer</label>
                    </div>
                    <div class="header-footer-options" id="footer-options">
                        <input type="text" id="footer-text" placeholder="Footer text" />
                        <div class="position-group">
                            <button class="position-btn selected" data-position="left">Left</button>
                            <button class="position-btn" data-position="center">Center</button>
                            <button class="position-btn" data-position="right">Right</button>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enable-pagination" checked />
                        <label for="enable-pagination">Page Numbers</label>
                    </div>
                    <input type="text" id="pagination-format" placeholder="Page {page} of {total}" value="Page {page} of {total}" style="margin-top: 6px; display: none;" />
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="export-pdf">Export PDF</button>
                <button class="btn btn-secondary" id="clear-text">Clear</button>
            </div>

            <div style="margin-top: 20px; font-size: 11px; color: #95a5a6; line-height: 1.4;">
                <p><strong>Tips:</strong></p>
                <ul style="margin-left: 12px; margin-top: 8px;">
                    <li>Use <code style="background: #34495e; color: #3498db; padding: 2px 4px; border-radius: 2px;">---</code> to split slides</li>
                    <li>Auto-saves to your browser</li>
                    <li>HTML is disabled for safety</li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="editor-section">
                <div class="editor-header">Markdown Input</div>
                <textarea id="markdown-input" placeholder="Paste or type your Markdown here...

# Example Heading

This is a paragraph with **bold** and *italic* text.

## Lists

- Item 1
- Item 2
- Item 3

---

# Second Slide (use --- to separate slides)

Try it out!"></textarea>
            </div>

            <div class="preview-section">
                <div class="preview-header">Live Preview</div>
                <div class="preview-container">
                    <div id="document-preview" class="preview-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Initialize markdown-it with HTML disabled (safe by default)
        const md = window.markdownit({
            html: false,
            linkify: true,
            typographer: true,
            breaks: true
        });

        // State
        let appState = {
            mode: 'document',
            markdown: localStorage.getItem('markdoc-markdown') || '',
            headerPos: localStorage.getItem('markdoc-headerPos') || 'left',
            footerPos: localStorage.getItem('markdoc-footerPos') || 'left'
        };

        // Elements
        const input = document.getElementById('markdown-input');
        const previewContainer = document.getElementById('document-preview');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const exportBtn = document.getElementById('export-pdf');
        const clearBtn = document.getElementById('clear-text');
        const enableHeaderCheckbox = document.getElementById('enable-header');
        const enableFooterCheckbox = document.getElementById('enable-footer');
        const enablePaginationCheckbox = document.getElementById('enable-pagination');
        const paginationFormatInput = document.getElementById('pagination-format');

        // Restore saved markdown
        input.value = appState.markdown;

        // Restore UI state
        enableHeaderCheckbox.checked = localStorage.getItem('markdoc-headerEnabled') === 'true';
        document.getElementById('header-options').classList.toggle('visible', enableHeaderCheckbox.checked);
        document.getElementById('header-text').value = localStorage.getItem('markdoc-headerText') || '';

        enableFooterCheckbox.checked = localStorage.getItem('markdoc-footerEnabled') === 'true';
        document.getElementById('footer-options').classList.toggle('visible', enableFooterCheckbox.checked);
        document.getElementById('footer-text').value = localStorage.getItem('markdoc-footerText') || '';

        enablePaginationCheckbox.checked = localStorage.getItem('markdoc-paginationEnabled') !== 'false';
        paginationFormatInput.style.display = enablePaginationCheckbox.checked ? 'block' : 'none';
        paginationFormatInput.value = localStorage.getItem('markdoc-paginationFormat') || 'Page {page} of {total}';

        // Debounce render
        let renderTimeout;
        function scheduleRender() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                appState.markdown = input.value;
                localStorage.setItem('markdoc-markdown', appState.markdown);
                render();
            }, 200);
        }

        // Render preview
        function render() {
            const html = md.render(appState.markdown);

            if (appState.mode === 'document') {
                previewContainer.innerHTML = html;
            } else {
                // Split on horizontal rulers (---, ***, ___)
                const slides = appState.markdown.split(/^(---|___|[\*]{3})$/m).filter((s, i) => i % 2 === 0);
                const slideHTML = slides.map(slide => {
                    const slideContent = md.render(slide.trim());
                    return `<div class="slide"><div class="preview-content">${slideContent}</div></div>`;
                }).join('');
                previewContainer.innerHTML = slideHTML;
            }
        }

        // Mode toggle
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                appState.mode = btn.dataset.mode;
                localStorage.setItem('markdoc-mode', appState.mode);
                render();
            });
        });

        // Restore saved mode
        const savedMode = localStorage.getItem('markdoc-mode') || 'document';
        if (savedMode !== 'document') {
            appState.mode = savedMode;
            document.querySelector(`[data-mode="${savedMode}"]`).classList.add('active');
            document.querySelector('[data-mode="document"]').classList.remove('active');
        }

        // Header/Footer toggles
        enableHeaderCheckbox.addEventListener('change', () => {
            document.getElementById('header-options').classList.toggle('visible');
            localStorage.setItem('markdoc-headerEnabled', enableHeaderCheckbox.checked);
        });

        enableFooterCheckbox.addEventListener('change', () => {
            document.getElementById('footer-options').classList.toggle('visible');
            localStorage.setItem('markdoc-footerEnabled', enableFooterCheckbox.checked);
        });

        enablePaginationCheckbox.addEventListener('change', () => {
            paginationFormatInput.style.display = enablePaginationCheckbox.checked ? 'block' : 'none';
            localStorage.setItem('markdoc-paginationEnabled', enablePaginationCheckbox.checked);
        });

        // Save text inputs
        document.getElementById('header-text').addEventListener('input', function() {
            localStorage.setItem('markdoc-headerText', this.value);
        });
        document.getElementById('footer-text').addEventListener('input', function() {
            localStorage.setItem('markdoc-footerText', this.value);
        });
        document.getElementById('pagination-format').addEventListener('input', function() {
            localStorage.setItem('markdoc-paginationFormat', this.value);
        });

        // Position buttons
        document.querySelectorAll('.position-group').forEach(group => {
            group.addEventListener('click', (e) => {
                if (e.target.classList.contains('position-btn')) {
                    const parent = e.target.parentElement;
                    parent.querySelectorAll('.position-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');

                    if (group.closest('#header-options')) {
                        appState.headerPos = e.target.dataset.position;
                        localStorage.setItem('markdoc-headerPos', appState.headerPos);
                    } else {
                        appState.footerPos = e.target.dataset.position;
                        localStorage.setItem('markdoc-footerPos', appState.footerPos);
                    }
                }
            });
        });

        // Restore header/footer position
        document.querySelectorAll('[data-position]').forEach(btn => {
            if (btn.closest('#header-options') && btn.dataset.position === appState.headerPos) {
                btn.classList.add('selected');
            }
            if (btn.closest('#footer-options') && btn.dataset.position === appState.footerPos) {
                btn.classList.add('selected');
            }
        });

        // Input event
        input.addEventListener('input', scheduleRender);

        // Clear button
        clearBtn.addEventListener('click', () => {
            if (confirm('Clear all markdown? This cannot be undone.')) {
                input.value = '';
                appState.markdown = '';
                localStorage.setItem('markdoc-markdown', '');
                render();
            }
        });

        // Helper: Extract text content from HTML with styling info
        function extractTextWithStyle(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            const lines = [];
            let listIndex = { ol: 0 };

            function traverse(node, style = {}, indent = 0) {
                if (node.nodeType === 3) { // Text node
                    const text = node.textContent;
                    if (text.trim()) {
                        lines.push({ text: text, style: { ...style }, indent });
                    }
                } else if (node.nodeType === 1) { // Element node
                    const tagName = node.tagName.toLowerCase();
                    let newStyle = { ...style };

                    if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tagName)) {
                        newStyle.fontSize = tagName === 'h1' ? 18 : tagName === 'h2' ? 14 : tagName === 'h3' ? 12 : tagName === 'h4' ? 11 : tagName === 'h5' ? 10 : 10;
                        newStyle.bold = true;
                        lines.push({ text: '\n', style: newStyle, isBreak: true, indent });
                    }

                    if (tagName === 'strong' || tagName === 'b') newStyle.bold = true;
                    if (tagName === 'em' || tagName === 'i') newStyle.italic = true;
                    if (tagName === 'code') {
                        newStyle.mono = true;
                        newStyle.fontSize = 10;
                    }

                    if (tagName === 'ul') {
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent));
                    } else if (tagName === 'ol') {
                        listIndex.ol = 0;
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent));
                    } else if (tagName === 'li') {
                        const parentTag = node.parentElement?.tagName.toLowerCase();
                        let bullet = '• ';
                        if (parentTag === 'ol') {
                            listIndex.ol++;
                            bullet = `${listIndex.ol}. `;
                        }
                        lines.push({ text: '  '.repeat(indent) + bullet, style: newStyle, indent });
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent + 1));
                        lines.push({ text: '\n', style: newStyle, isBreak: true, indent });
                    } else if (tagName === 'pre') {
                        const codeText = node.textContent;
                        const codeLines = codeText.split('\n');
                        codeLines.forEach(line => {
                            lines.push({ text: line, style: { ...newStyle, mono: true, fontSize: 10 }, indent: indent + 1 });
                            lines.push({ text: '\n', style: { ...newStyle, mono: true, fontSize: 10 }, isBreak: true, indent: indent + 1 });
                        });
                    } else if (tagName === 'blockquote') {
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent + 2));
                    } else if (tagName === 'table') {
                        // Skip tables for now, or simple text
                        lines.push({ text: '[Table]', style: newStyle, indent });
                        lines.push({ text: '\n', style: newStyle, isBreak: true, indent });
                    } else if (['p', 'div'].includes(tagName)) {
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent));
                        lines.push({ text: '\n', style: newStyle, isBreak: true, indent });
                    } else {
                        Array.from(node.childNodes).forEach(child => traverse(child, newStyle, indent));
                    }
                }
            }

            traverse(div);
            return lines;
        }

        // PDF Export (Fixed Version)
        exportBtn.addEventListener('click', async () => {
        exportBtn.disabled = true;
        exportBtn.textContent = 'Exporting...';

        try {
            const jsPDF = window.jspdf.jsPDF;
            
            // --- SETTINGS ---
            // Capture user settings, but we might override them for slides
            let paperSize = document.getElementById('pdf-paper').value;
            let orientation = document.getElementById('pdf-orientation').value;
            let marginTop = parseInt(document.getElementById('margin-top').value) || 0;
            let marginRight = parseInt(document.getElementById('margin-right').value) || 0;
            let marginBottom = parseInt(document.getElementById('margin-bottom').value) || 0;
            let marginLeft = parseInt(document.getElementById('margin-left').value) || 0;

            const headerEnabled = enableHeaderCheckbox.checked;
            const footerEnabled = enableFooterCheckbox.checked;
            const paginationEnabled = enablePaginationCheckbox.checked;
            
            // --- MODE ADJUSTMENTS ---
            // If in Slides mode, force Landscape and remove margins to make it look like a deck
            if (appState.mode === 'slides') {
                orientation = 'landscape';
                marginTop = 0; 
                marginRight = 0; 
                marginBottom = 0; 
                marginLeft = 0;
            }

            // Initialize PDF
            const pdf = new jsPDF({
                orientation: orientation === 'portrait' ? 'p' : 'l',
                unit: 'mm',
                format: paperSize === 'letter' ? 'letter' : 'a4'
            });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const contentWidth = pageWidth - marginLeft - marginRight;
            
            // --- HELPER FUNCTIONS ---
            let currentPageNum = 0;

            const addNewPage = () => {
                if (currentPageNum > 0) pdf.addPage();
                currentPageNum++;
                
                // Draw header
                if (headerEnabled) {
                    pdf.setFontSize(11);
                    pdf.setTextColor(100);
                    const headerX = { left: marginLeft, center: pageWidth / 2, right: pageWidth - marginRight };
                    const effectiveY = marginTop === 0 ? 8 : marginTop - 4;
                    pdf.text(document.getElementById('header-text').value, headerX[appState.headerPos], effectiveY, { align: appState.headerPos });
                }
            };

            const drawFooterAndPageNum = () => {
                if (footerEnabled) {
                    pdf.setFontSize(11);
                    pdf.setTextColor(100);
                    const footerX = { left: marginLeft, center: pageWidth / 2, right: pageWidth - marginRight };
                    const effectiveY = marginBottom === 0 ? pageHeight - 8 : pageHeight - marginBottom + 4;
                    pdf.text(document.getElementById('footer-text').value, footerX[appState.footerPos], effectiveY, { align: appState.footerPos });
                }

                if (paginationEnabled) {
                    pdf.setFontSize(10);
                    pdf.setTextColor(120);
                    const totalPages = pdf.internal.pages.length - 1;
                    const pageText = (paginationFormatInput.value || 'Page {page} of {total}')
                        .replace('{page}', currentPageNum)
                        .replace('{total}', totalPages);
                    const effectiveY = marginBottom === 0 ? pageHeight - 8 : pageHeight - marginBottom + 4;
                    pdf.text(pageText, pageWidth / 2, effectiveY, { align: 'center' });
                }
            };

            // --- RENDER LOGIC ---

            if (appState.mode === 'document') {
                // Vector PDF generation with professional typesetting
                const html = md.render(appState.markdown);
                const lines = extractTextWithStyle(html);
                const headerH = headerEnabled ? 15 : 0;
                const footerH = footerEnabled ? 15 : 0;
                const availableHeight = pageHeight - marginTop - marginBottom - headerH - footerH;

                let currentY = marginTop + headerH;
                addNewPage();

                for (const line of lines) {
                    const fontSize = line.style.fontSize || 12;
                    const lineHeight = fontSize * 1.5;
                    const indentX = marginLeft + (line.indent || 0) * 6; // 6mm per indent level for professional spacing

                    if (line.isBreak) {
                        currentY += lineHeight;
                    } else {
                        pdf.setFontSize(fontSize);
                        let fontName = line.style.mono ? 'courier' : 'times';
                        let fontStyle = 'normal';
                        if (line.style.bold && line.style.italic) fontStyle = 'bolditalic';
                        else if (line.style.bold) fontStyle = 'bold';
                        else if (line.style.italic) fontStyle = 'italic';
                        pdf.setFont(fontName, fontStyle);

                        if (line.style.mono) {
                            // Code blocks with background
                            const textWidth = pdf.getTextWidth(line.text);
                            pdf.setFillColor(245, 245, 245);
                            pdf.rect(indentX - 2, currentY - fontSize * 0.8, textWidth + 4, fontSize * 1.2, 'F');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(line.text, indentX, currentY);
                            currentY += lineHeight;
                        } else {
                            // Word wrap for regular text
                            const words = line.text.split(/\s+/);
                            let currentLine = '';
                            let lineY = currentY;
                            for (const word of words) {
                                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                                const testWidth = pdf.getTextWidth(testLine);
                                if (testWidth > contentWidth - (line.indent || 0) * 6 && currentLine) {
                                    pdf.text(currentLine, indentX, lineY);
                                    lineY += lineHeight;
                                    currentLine = word;
                                    if (lineY + lineHeight > pageHeight - marginBottom - footerH) {
                                        drawFooterAndPageNum();
                                        addNewPage();
                                        lineY = marginTop + headerH;
                                    }
                                } else {
                                    currentLine = testLine;
                                }
                            }
                            if (currentLine) {
                                pdf.text(currentLine, indentX, lineY);
                                currentY = lineY + lineHeight;
                            }
                        }
                    }

                    if (currentY > pageHeight - marginBottom - footerH) {
                        drawFooterAndPageNum();
                        addNewPage();
                        currentY = marginTop + headerH;
                    }
                }
                drawFooterAndPageNum();
            } else {
                // --- SLIDES MODE ---
                const slides = Array.from(document.querySelectorAll('.slide'));

                for (let i = 0; i < slides.length; i++) {
                    addNewPage();

                    // Capture slide
                    const canvas = await html2canvas(slides[i], {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });

                    // Enforce 16:9 aspect ratio for slides
                    const targetRatio = 16 / 9;
                    const slideRatio = canvas.width / canvas.height;
                    const pageRatio = pageWidth / pageHeight;

                    let boxWidth, boxHeight;
                    if (pageRatio > targetRatio) {
                        boxHeight = pageHeight;
                        boxWidth = pageHeight * targetRatio;
                    } else {
                        boxWidth = pageWidth;
                        boxHeight = pageWidth / targetRatio;
                    }

                    const scale = Math.min(boxWidth / canvas.width, boxHeight / canvas.height);
                    const finalW = canvas.width * scale;
                    const finalH = canvas.height * scale;

                    // Center the slide on the page
                    const x = (pageWidth - finalW) / 2;
                    const y = (pageHeight - finalH) / 2;

                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', x, y, finalW, finalH, undefined, 'FAST');
                    
                    drawFooterAndPageNum();
                }
            }

            pdf.save('markdoc-export.pdf');

        } catch (error) {
            console.error('PDF export error:', error);
            alert('Error exporting PDF: ' + error.message);
        } finally {
            exportBtn.disabled = false;
            exportBtn.textContent = 'Export PDF';
        }
    });


        // Initial render
        render();
    </script>
</body>
</html>
